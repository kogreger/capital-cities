# Capital Cities (Urban Mobility)

```{r initialization, eval = TRUE, echo = FALSE, message = FALSE}
## initialize and load required packages
library(ggplot2)
library(gridExtra)
library(RPostgreSQL)
library(scales)

## initialize database connection and psql helper functions
drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv, 
                 host = "localhost", 
                 port = "1111", 
                 user = "postgres", 
                 password = "postgres", 
                 dbname = "pflow")

source("psqlHelper.R")

## initialize ggplot
theme_set(theme_bw())
```



## Sample Populations

This section covers the descriptive statistics of the four sample populations.

```{r loadVariableLabels, eval = TRUE, echo = FALSE, message = FALSE}
# load variable labels
labelsSex <- read.table("labels_all_sex.txt", sep = "\t")
labelsAge <- read.table("labels_all_age.txt", sep = "\t")
labelsOccupC <- read.table("labels_all_occupc.txt", sep = "\t")
labelsDhk09Occup <- read.table("labels_dhk09_occup.txt", sep = "\t")
labelsHni04Occup <- read.table("labels_hni04_occup.txt", sep = "\t")
labelsJkt02Occup <- read.table("labels_jkt02_occup.txt", sep = "\t")
labelsMnl96Occup <- read.table("labels_mnl96_occup.txt", sep = "\t")
```


### Dhaka 2009

```{r loadDhk09Person, eval = TRUE, echo = FALSE}
## dhk09
dhk09.person <- psqlGetTable(con, "dhk09", "person")
# remove unnecessary columns (padd, magfac, magfac2)
dhk09.person <- dhk09.person[, c("pid", "sex", "age", "occup", "occupc")]
# factorize pid
dhk09.person$pid <- factor(dhk09.person$pid)
# remove NA sex (=0) and factorize
dhk09.person <- dhk09.person[dhk09.person$sex != 0, ]
dhk09.person$sex <- factor(dhk09.person$sex, 
                           levels = c(1, 2), 
                           labels = labelsSex[, 2])
# factorize age (ordered)
dhk09.person$age <- factor(dhk09.person$age, 
                           levels = c(0:17), 
                           ordered = TRUE, 
                           labels = labelsAge[, 2])
# factorize occupation
dhk09.person$occup <- factor(dhk09.person$occup, 
                             levels = c(0:8), 
                             labels = labelsDhk09Occup[, 2])
# factorize occupation class
dhk09.person$occupc <- factor(dhk09.person$occupc, 
                              levels = c(1:5, 99), 
                              labels = labelsOccupC[, 2])
```

The data were captured on October 1-2, 2009 with a sample size of `r format(nrow(dhk09.person), big.mark=",")` people.

Data set description:

```{r descDhk09Person}
names(dhk09.person)
str(dhk09.person)
levels(dhk09.person$sex)
levels(dhk09.person$age)
levels(dhk09.person$occup)
levels(dhk09.person$occupc)
```

```{r plotHistDhk09Person, eval = TRUE, echo = FALSE, fig.width = 7, fig.height = 28}
plotDhk09Sex <- ggplot(dhk09.person, aes(sex)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Dhaka 2009, Sex", x = "Sex", y = "Count")
plotDhk09Age <- ggplot(dhk09.person, aes(age)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Dhaka 2009, Age", x = "Age", y = "Count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
plotDhk09Occup <- ggplot(dhk09.person, aes(occup)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Dhaka 2009, Occupation", x = "Occupation", y = "Count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
plotDhk09Occupc <- ggplot(dhk09.person, aes(occupc)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Dhaka 2009, Occupation Group", 
       x = "Occupation Group", 
       y = "Count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
grid.arrange(plotDhk09Sex, plotDhk09Age, plotDhk09Occup, plotDhk09Occupc, 
             ncol = 1)
```


### Hanoi 2004

```{r loadHni04Person, eval = TRUE, echo = FALSE}
## hni04
hni04.person <- psqlGetTable(con, "hni04", "person")
# remove unnecessary columns (padd, magfac, magfac2)
hni04.person <- hni04.person[, c("pid", "sex", "age", "occup", "occupc")]
# factorize pid
hni04.person$pid <- factor(hni04.person$pid)
# factorize sex
hni04.person$sex <- factor(hni04.person$sex, 
                           levels = c(1, 2), 
                           labels = labelsSex[, 2])
# factorize age (ordered)
hni04.person$age <- factor(hni04.person$age, 
                           levels = c(0:17), 
                           ordered = TRUE, 
                           labels = labelsAge[, 2])
# factorize occupation
hni04.person$occup <- factor(hni04.person$occup, 
                             levels = c(0:16, 99), 
                             labels = labelsHni04Occup[, 2])
# factorize occupation class
hni04.person$occupc <- factor(hni04.person$occupc, 
                              levels = c(1:5, 99), 
                              labels = labelsOccupC[, 2])
```

The data were captured on October 1-2, 2004 with a sample size of `r format(nrow(hni04.person), big.mark=",")` people.

Data set description:

```{r descHni04Person}
names(hni04.person)
str(hni04.person)
levels(hni04.person$sex)
levels(hni04.person$age)
levels(hni04.person$occup)
levels(hni04.person$occupc)
```

```{r plotHistHni04Person, eval = TRUE, echo = FALSE, fig.width = 7, fig.height = 28}
plotHni04Sex <- ggplot(hni04.person, aes(sex)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Hanoi 2004, Sex", x = "Sex", y = "Count")
plotHni04Age <- ggplot(hni04.person, aes(age)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Hanoi 2004, Age", x = "Age", y = "Count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
plotHni04Occup <- ggplot(hni04.person, aes(occup)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Hanoi 2004, Occupation", x = "Occupation", y = "Count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
plotHni04Occupc <- ggplot(hni04.person, aes(occupc)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Hanoi 2004, Occupation Group", 
       x = "Occupation Group", 
       y = "Count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
grid.arrange(plotHni04Sex, plotHni04Age, plotHni04Occup, plotHni04Occupc, 
             ncol = 1)
```


### Jakarta 2002

```{r loadJkt02Person, eval = TRUE, echo = FALSE}
## jkt02
jkt02.person <- psqlGetTable(con, "jkt02", "person")
# remove unnecessary columns (padd, magfac, magfac2)
jkt02.person <- jkt02.person[, c("pid", "sex", "age", "occup", "occupc")]
# factorize pid
jkt02.person$pid <- factor(jkt02.person$pid)
# factorize sex
jkt02.person$sex <- factor(jkt02.person$sex, 
                           levels = c(1, 2), 
                           labels = labelsSex[, 2])
# factorize age (ordered, no 0)
jkt02.person$age <- factor(jkt02.person$age, 
                           levels = c(0:17), 
                           ordered = TRUE, 
                           labels = labelsAge[, 2])
# factorize occupation
jkt02.person$occup <- factor(jkt02.person$occup, 
                             levels = c(0:17, 99), 
                             labels = labelsJkt02Occup[, 2])
# factorize occupation class
jkt02.person$occupc <- factor(jkt02.person$occupc, 
                              levels = c(1:5, 99), 
                              labels = labelsOccupC[, 2])
```

The data were captured on October 1-2, 2002 with a sample size of `r format(nrow(jkt02.person), big.mark=",")` people.

Data set description:

```{r descJkt02Person}
names(jkt02.person)
str(jkt02.person)
levels(jkt02.person$sex)
levels(jkt02.person$age)
levels(jkt02.person$occup)
levels(jkt02.person$occupc)
```

```{r plotHistJkt02Person, eval = TRUE, echo = FALSE, fig.width = 7, fig.height = 28}
plotJkt02Sex <- ggplot(jkt02.person, aes(sex)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Jakarta 2002, Sex", x = "Sex", y = "Count")
plotJkt02Age <- ggplot(jkt02.person, aes(age)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Jakarta 2002, Age", x = "Age", y = "Count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
plotJkt02Occup <- ggplot(jkt02.person, aes(occup)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Jakarta 2002, Occupation", x = "Occupation", y = "Count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
plotJkt02Occupc <- ggplot(jkt02.person, aes(occupc)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Jakarta 2002, Occupation Group", 
       x = "Occupation Group", 
       y = "Count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
grid.arrange(plotJkt02Sex, plotJkt02Age, plotJkt02Occup, plotJkt02Occupc, 
             ncol = 1)
```


### Metro Manila 1996

```{r loadMnl96Person, eval = TRUE, echo = FALSE}
## mnl96
mnl96.person <- psqlGetTable(con, "mnl96", "person")
# remove unnecessary columns (padd, magfac, magfac2)
mnl96.person <- mnl96.person[, c("pid", "sex", "age", "occup", "occupc")]
# factorize pid
mnl96.person$pid <- factor(mnl96.person$pid)
# factorize sex
mnl96.person$sex <- factor(mnl96.person$sex, 
                           levels = c(1, 2), 
                           labels = labelsSex[, 2])
# factorize age (ordered, no 0)
mnl96.person$age <- factor(mnl96.person$age, 
                           levels = c(0:17), 
                           ordered = TRUE, 
                           labels = labelsAge[, 2])
# factorize occupation
mnl96.person$occup <- factor(mnl96.person$occup, 
                             levels = c(1:14, 99), 
                             labels = labelsMnl96Occup[, 2])
# factorize occupation class
mnl96.person$occupc <- factor(mnl96.person$occupc, 
                              levels = c(1:5, 99), 
                              labels = labelsOccupC[, 2])
```

The data were captured on October 1-2, 1996 with a sample size of `r format(nrow(mnl96.person), big.mark=",")` people.

Data set description:

```{r descMnl96Person}
names(mnl96.person)
str(mnl96.person)
levels(mnl96.person$sex)
levels(mnl96.person$age)
levels(mnl96.person$occup)
levels(mnl96.person$occupc)
```

```{r plotHistMnl96Person, eval = TRUE, echo = FALSE, fig.width = 7, fig.height = 28}
plotMnl96Sex <- ggplot(mnl96.person, aes(sex)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Metro Manila 1996, Sex", x = "Sex", y = "Count")
plotMnl96Age <- ggplot(mnl96.person, aes(age)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Metro Manila 1996, Age", x = "Age", y = "Count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
plotMnl96Occup <- ggplot(mnl96.person, aes(occup)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Metro Manila 1996, Occupation", x = "Occupation", y = "Count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
plotMnl96Occupc <- ggplot(mnl96.person, aes(occupc)) +
  geom_bar() +
  scale_y_continuous(labels = comma) +
  labs(title = "Metro Manila 1996, Occupation Group", 
       x = "Occupation Group", 
       y = "Count") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
grid.arrange(plotMnl96Sex, plotMnl96Age, plotMnl96Occup, plotMnl96Occupc, 
             ncol = 1)
```


### Comparison Across Cities

#### Sex

```{r plotHistPersonSexAll, eval = TRUE, echo = FALSE, fig.width = 10, fig.height = 10}
grid.arrange(plotDhk09Sex, plotHni04Sex, plotJkt02Sex, plotMnl96Sex, 
             ncol = 2, 
             main = "Sex")
```

#### Age

```{r plotHistPersonAgeAll, eval = TRUE, echo = FALSE, fig.width = 10, fig.height = 10}
grid.arrange(plotDhk09Age, plotHni04Age, plotJkt02Age, plotMnl96Age, 
             ncol = 2, 
             main = "Age")
```

#### Occupation

```{r plotHistPersonOccupAll, eval = TRUE, echo = FALSE, fig.width = 10, fig.height = 10}
grid.arrange(plotDhk09Occup, plotHni04Occup, plotJkt02Occup, plotMnl96Occup, 
             ncol = 2, 
             main = "Occupation")
```

#### Occupation Group

```{r plotHistPersonOccupcAll, eval = TRUE, echo = FALSE, fig.width = 10, fig.height = 10}
grid.arrange(plotDhk09Occupc, plotHni04Occupc, plotJkt02Occupc, plotMnl96Occupc, 
             ncol = 2, 
             main = "Occupation Group")
```


## Spatio-Temporal Distribution of Trip Origins

This section covers the analysis of the distribution of the origins of trips in all four cities over space and time. For analysis purposes we generated concentric ring buffers in 5km distances from the centers of all four cities (as per the OpenStreetMap data).

```{r loadTripOriginsDhk09, eval = TRUE, echo = FALSE}

```



## Final Steps

It's always a good idea to clean up after you're done...

```{r cleanup, eval = TRUE, echo = FALSE, message = FALSE}
## clean up database connection and database driver
dbDisconnect(con)
dbUnloadDriver(drv)
```
